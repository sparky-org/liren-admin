<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sparky.lirenadmin.mapper.ext.TaskMapperExt">
  <resultMap id="TaskPOResultMap" type="com.sparky.lirenadmin.entity.po.MyTaskPO">
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="title" jdbcType="VARCHAR" property="title" />
    <result column="content" jdbcType="VARCHAR" property="content" />
    <result column="point_no" jdbcType="BIGINT" property="pointNo" />
    <result column="join_limit" jdbcType="INTEGER" property="joinLimit" />
    <result column="scope" jdbcType="VARCHAR" property="scope" />
    <result column="shop_no" jdbcType="BIGINT" property="shopNo" />
    <result column="creator" jdbcType="BIGINT" property="creator" />
    <result column="is_valid" jdbcType="TINYINT" property="isValid" />
    <result column="emp_no" jdbcType="BIGINT" property="empNo" />
    <result column="status" jdbcType="VARCHAR" property="status" />
    <result column="gmt_create" jdbcType="TIMESTAMP" property="gmtCreate" />
    <result column="gmt_modify" jdbcType="TIMESTAMP" property="gmtModify" />
  </resultMap>

  <sql id="query_cond_from_clause">
    select id, title, content, point_no, join_limit, scope, shop_no,#{cond.empNo} as emp_no,'UNCOMPLETE' as status, creator, is_valid, gmt_create,
    gmt_modify
    from t_task a
    where (
          id in (select task_no from t_task_dtl where emp_no = #{cond.empNo} and is_valid=1)
          or scope = 'ALL'
        )
      and not exists (select task_no from t_task_record where emp_no = #{cond.empNo} and is_valid=1 and a.id = task_no)
      <if test="cond.pointType != null">
        a.point_no = #{cond.point_no}
      </if>
    union all
    select id, title, content, point_no, join_limit, scope, shop_no,#{cond.empNo} as emp_no,'COMPLETE' as status, creator, is_valid, gmt_create,
    gmt_modify
    from (select id, title, content, point_no, join_limit, scope, shop_no, creator, is_valid, gmt_create, gmt_modify from t_task where is_valid = 1) m
    left join (select task_no from t_task_record where emp_no = #{cond.empNo} and is_valid=1) n on m.id = n.task_no
    where n.task_no is not null
  </sql>

  <select id="countByQueryCond" resultType="java.lang.Integer">
    select count(*) as count
      from (<include refid="query_cond_from_clause"/>) x
  </select>

  <select id="pagingByQueryCond" resultMap="TaskPOResultMap">
    select
    x.id, x.title, x.content, x.point_no, x.join_limit, x.scope, x.shop_no,#{cond.empNo} as emp_no,x.status, x.creator, x.is_valid, x.gmt_create,
    x.gmt_modify
    from (<include refid="query_cond_from_clause"/>) x
    order by status
    limit #{cond.start}, #{cond.length}
  </select>
</mapper>