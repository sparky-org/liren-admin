<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sparky.lirenadmin.mapper.ext.RewardRecordMapperExt">
  <resultMap id="PointRankPOResultMap" type="com.sparky.lirenadmin.entity.po.PointRankPO">
    <result column="emp_no" jdbcType="BIGINT" property="empNo" />
    <result column="point" jdbcType="INTEGER" property="point" />
    <result column="rownum" jdbcType="VARCHAR" property="rank" />
  </resultMap>

  <select id="findPointRank" resultMap="PointRankPOResultMap">
    select b.emp_no, b.point, b.rownum from (
      select emp_no, point, @rownum:=@rownum+1 as rownum from (
         select emp_no, sum(point) as point, @rownum:=0  AS rownum
           from t_reward_record where STR_TO_DATE(DATE_FORMAT(reward_time,'%Y-%m-%d'),'%Y-%m-%d')=STR_TO_DATE(#{date},'%Y-%m-%d')  group by emp_no order by point desc
      ) a
    ) b where b.emp_no=#{empNo} or b.rownum=1;
  </select>

  <select id="countRewardRecord" resultType="java.lang.Integer">
    select count(*)
      from t_reward_record
     where shopNo = #{shopNo}
       and is_valid = 1
  </select>

  <select id="pagingQueryRewardRecord" resultMap="BaseResultMap">
    select *
      from t_reward_record
     where shopNo = #{shopNo}
       and is_valid = 1
     order by gmt_create
     limit #{start}, #{pageSize}
  </select>
</mapper>